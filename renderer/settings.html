<!-- Settings Page Content -->
<div class="settings-container">
    <div class="settings-header">
        <h2>‚öôÔ∏è C√†i ƒë·∫∑t h·ªá th·ªëng</h2>
        <button class="btn-primary" onclick="settingsManager.saveSettings()">
            üíæ L∆∞u c√†i ƒë·∫∑t
        </button>
    </div>

    <div class="settings-sections">
        <!-- Database Settings -->
        <div class="settings-card">
            <div class="card-header">
                <span class="icon">üíæ</span>
                <h3>C·∫•u h√¨nh Database</h3>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <label>Database Type</label>
                    <select id="databaseType">
                        <option value="sqlite">SQLite (Local)</option>
                        <option value="postgresql">PostgreSQL (Production)</option>
                    </select>
                </div>
                <div class="input-group" id="postgresConfig" style="display: none;">
                    <label>PostgreSQL Connection String</label>
                    <input type="text" id="databaseUrl" placeholder="postgresql://user:pass@host:5432/dbname">
                </div>
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="autoBackup">
                        T·ª± ƒë·ªông sao l∆∞u database h√†ng ng√†y
                    </label>
                </div>
            </div>
        </div>

        <!-- Facebook API Settings -->
        <div class="settings-card">
            <div class="card-header">
                <span class="icon">üìò</span>
                <h3>Facebook API</h3>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <label>Facebook App ID</label>
                    <input type="text" id="facebookAppId" placeholder="Nh·∫≠p App ID">
                </div>
                <div class="input-group">
                    <label>Facebook App Secret</label>
                    <input type="password" id="facebookAppSecret" placeholder="Nh·∫≠p App Secret">
                </div>
                <div class="input-group">
                    <label>Webhook Verify Token</label>
                    <input type="text" id="webhookVerifyToken" placeholder="Nh·∫≠p verify token">
                </div>
                <div class="info-box">
                    <h4>üìå H∆∞·ªõng d·∫´n c·∫•u h√¨nh Webhook</h4>
                    <p>1. Truy c·∫≠p <a href="https://developers.facebook.com" target="_blank">Facebook Developers</a></p>
                    <p>2. Ch·ªçn app c·ªßa b·∫°n ‚Üí Webhooks ‚Üí Edit Subscription</p>
                    <p>3. Callback URL: <code id="webhookUrl">http://your-server.com/webhook</code></p>
                    <p>4. Verify Token: Nh·∫≠p token b√™n tr√™n</p>
                    <p>5. Subscribe to: feed, comments, reactions, mention</p>
                </div>
            </div>
        </div>

        <!-- Telegram Bot Settings -->
        <div class="settings-card">
            <div class="card-header">
                <span class="icon">üì±</span>
                <h3>Telegram Bot</h3>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <label>Bot Token</label>
                    <input type="password" id="telegramBotToken" placeholder="1234567890:ABCdef...">
                </div>
                <div class="input-group">
                    <label>Chat ID</label>
                    <input type="text" id="telegramChatId" placeholder="123456789">
                </div>
                <div class="input-group">
                    <button class="btn-secondary" onclick="settingsManager.testTelegram()">
                        üß™ Test th√¥ng b√°o
                    </button>
                </div>
                <div class="info-box">
                    <h4>üìå H∆∞·ªõng d·∫´n l·∫•y Bot Token v√† Chat ID</h4>
                    <p>1. T·∫°o bot: Message @BotFather tr√™n Telegram ‚Üí /newbot</p>
                    <p>2. Copy Bot Token ƒë∆∞·ª£c cung c·∫•p</p>
                    <p>3. L·∫•y Chat ID: Message @userinfobot ‚Üí Copy ID c·ªßa b·∫°n</p>
                    <p>4. Nh·∫Øn tin cho bot c·ªßa b·∫°n ƒë·ªÉ k√≠ch ho·∫°t</p>
                </div>
            </div>
        </div>

        <!-- Notification Settings -->
        <div class="settings-card">
            <div class="card-header">
                <span class="icon">üîî</span>
                <h3>C√†i ƒë·∫∑t th√¥ng b√°o</h3>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="notifyTaskComplete" checked>
                        Th√¥ng b√°o khi task ho√†n th√†nh
                    </label>
                </div>
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="notifyTaskFailed" checked>
                        Th√¥ng b√°o khi task th·∫•t b·∫°i
                    </label>
                </div>
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="notifyError" checked>
                        Th√¥ng b√°o l·ªói h·ªá th·ªëng
                    </label>
                </div>
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="notifyWebhook">
                        Th√¥ng b√°o s·ª± ki·ªán Facebook
                    </label>
                </div>
            </div>
        </div>

        <!-- ChromeDriver Settings -->
        <div class="settings-card">
            <div class="card-header">
                <span class="icon">üåê</span>
                <h3>ChromeDriver</h3>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="headlessMode">
                        Ch·∫ø ƒë·ªô headless (·∫©n tr√¨nh duy·ªát)
                    </label>
                </div>
                <div class="input-group">
                    <label>Max concurrent instances</label>
                    <input type="number" id="maxConcurrent" value="5" min="1" max="20">
                </div>
                <div class="input-group">
                    <label>Task timeout (gi√¢y)</label>
                    <input type="number" id="taskTimeout" value="300" min="30" max="3600">
                </div>
            </div>
        </div>

        <!-- Proxy Settings -->
        <div class="settings-card">
            <div class="card-header">
                <span class="icon">üîí</span>
                <h3>C·∫•u h√¨nh Proxy</h3>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <label>Proxy rotation strategy</label>
                    <select id="proxyRotation">
                        <option value="round-robin">Round Robin</option>
                        <option value="random">Random</option>
                        <option value="least-used">Least Used</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Proxy timeout (gi√¢y)</label>
                    <input type="number" id="proxyTimeout" value="30" min="5" max="300">
                </div>
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="autoAssignProxy" checked>
                        T·ª± ƒë·ªông g√°n proxy cho t√†i kho·∫£n m·ªõi
                    </label>
                </div>
            </div>
        </div>

        <!-- Rate Limiting -->
        <div class="settings-card">
            <div class="card-header">
                <span class="icon">‚è±Ô∏è</span>
                <h3>Rate Limiting</h3>
            </div>
            <div class="card-body">
                <div class="grid-2">
                    <div class="input-group">
                        <label>Min delay (gi√¢y)</label>
                        <input type="number" id="delayMin" value="5" min="1" max="60">
                    </div>
                    <div class="input-group">
                        <label>Max delay (gi√¢y)</label>
                        <input type="number" id="delayMax" value="15" min="1" max="60">
                    </div>
                </div>
                <div class="input-group">
                    <label>Max actions per hour</label>
                    <input type="number" id="maxActionsPerHour" value="100" min="10" max="1000">
                </div>
            </div>
        </div>

        <!-- Advanced Settings -->
        <div class="settings-card">
            <div class="card-header">
                <span class="icon">üîß</span>
                <h3>C√†i ƒë·∫∑t n√¢ng cao</h3>
            </div>
            <div class="card-body">
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="debugMode">
                        Debug mode (chi ti·∫øt log)
                    </label>
                </div>
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="retryFailedTasks" checked>
                        T·ª± ƒë·ªông retry tasks th·∫•t b·∫°i
                    </label>
                </div>
                <div class="input-group">
                    <label>Max retries</label>
                    <input type="number" id="maxRetries" value="3" min="1" max="10">
                </div>
                <div class="input-group">
                    <label>Log level</label>
                    <select id="logLevel">
                        <option value="DEBUG">DEBUG</option>
                        <option value="INFO" selected>INFO</option>
                        <option value="WARNING">WARNING</option>
                        <option value="ERROR">ERROR</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="settings-footer">
        <button class="btn-warning" onclick="settingsManager.resetToDefault()">
            üîÑ Kh√¥i ph·ª•c m·∫∑c ƒë·ªãnh
        </button>
        <button class="btn-primary" onclick="settingsManager.saveSettings()">
            üíæ L∆∞u t·∫•t c·∫£ c√†i ƒë·∫∑t
        </button>
    </div>
</div>

<script>
// Settings Manager - Updated to use new Settings API
const settingsManager = {
    async loadSettings() {
        try {
            // Use new API client
            const settings = await window.apiClient.getSettings();
            this.populateForm(settings);
            
            // Log success
            if (typeof app !== 'undefined') {
                app.addLog('info', 'ƒê√£ t·∫£i c√†i ƒë·∫∑t th√†nh c√¥ng');
            }
        } catch (error) {
            console.error('Error loading settings:', error);
            if (typeof app !== 'undefined') {
                app.addLog('error', `L·ªói t·∫£i c√†i ƒë·∫∑t: ${error.message}`);
            }
        }
    },

    populateForm(settings) {
        // Map API settings to form fields
        const fieldMapping = {
            // General settings
            'app_name': 'databaseType', // Not exact match but keep for backwards compatibility
            'language': null,
            'theme': null,
            
            // Database settings
            'database_type': 'databaseType',
            'auto_backup': 'autoBackup',
            
            // Facebook settings
            'facebook_app_id': 'facebookAppId',
            'facebook_app_secret': 'facebookAppSecret',
            'facebook_api_version': null,
            
            // Webhook settings
            'webhook_verify_token': 'webhookVerifyToken',
            
            // Telegram settings
            'telegram_enabled': null,
            'telegram_bot_token': 'telegramBotToken',
            'telegram_chat_id': 'telegramChatId',
            'telegram_notify_task_complete': 'notifyTaskComplete',
            'telegram_notify_task_failed': 'notifyTaskFailed',
            'telegram_notify_error': 'notifyError',
            'telegram_notify_webhook': 'notifyWebhook',
            
            // Task settings
            'default_delay': 'delayMin',
            'max_concurrent_tasks': 'maxConcurrent',
            'default_timeout': 'taskTimeout',
            'default_retry': 'maxRetries',
            
            // Proxy settings
            'auto_assign_proxy': 'autoAssignProxy',
            'rotate_proxy_on_error': null,
            'check_proxy_before_use': null,
            'proxy_timeout': 'proxyTimeout',
            
            // Automation settings
            'auto_start_tasks': null,
            'auto_restart_failed_tasks': 'retryFailedTasks',
            'save_logs_to_file': null,
            
            // Advanced settings
            'debug_mode': 'debugMode',
            'verbose_logging': null,
            'api_rate_limit': 'maxActionsPerHour',
            'log_level': 'logLevel'
        };

        // Populate form fields
        for (const [apiKey, formId] of Object.entries(fieldMapping)) {
            if (formId && settings[apiKey] !== undefined) {
                const element = document.getElementById(formId);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = settings[apiKey];
                    } else {
                        element.value = settings[apiKey];
                    }
                }
            }
        }
    },

    async saveSettings() {
        // Collect all settings from form
        const settings = {
            // General settings
            app_name: 'Bi Ads Multi Tool PRO',
            app_version: '3.0.0',
            language: 'vi',
            theme: 'dark',
            
            // Task settings
            default_delay: parseInt(document.getElementById('delayMin').value),
            default_retry: parseInt(document.getElementById('maxRetries').value),
            default_timeout: parseInt(document.getElementById('taskTimeout').value),
            max_concurrent_tasks: parseInt(document.getElementById('maxConcurrent').value),
            
            // Proxy settings
            auto_assign_proxy: document.getElementById('autoAssignProxy').checked,
            rotate_proxy_on_error: true,
            check_proxy_before_use: true,
            proxy_timeout: parseInt(document.getElementById('proxyTimeout').value),
            
            // Telegram settings
            telegram_enabled: true,
            telegram_bot_token: document.getElementById('telegramBotToken').value,
            telegram_chat_id: document.getElementById('telegramChatId').value,
            telegram_notify_task_complete: document.getElementById('notifyTaskComplete').checked,
            telegram_notify_task_failed: document.getElementById('notifyTaskFailed').checked,
            telegram_notify_error: document.getElementById('notifyError').checked,
            telegram_notify_webhook: document.getElementById('notifyWebhook').checked,
            
            // Facebook settings
            facebook_app_id: document.getElementById('facebookAppId').value,
            facebook_app_secret: document.getElementById('facebookAppSecret').value,
            facebook_api_version: 'v18.0',
            
            // Security settings
            enable_2fa: false,
            session_timeout: 3600,
            auto_logout: false,
            
            // Automation settings
            auto_start_tasks: false,
            auto_restart_failed_tasks: document.getElementById('retryFailedTasks').checked,
            save_logs_to_file: true,
            
            // Performance settings
            cache_enabled: true,
            cache_ttl: 300,
            batch_size: 10,
            
            // Advanced settings
            debug_mode: document.getElementById('debugMode').checked,
            verbose_logging: document.getElementById('debugMode').checked,
            api_rate_limit: parseInt(document.getElementById('maxActionsPerHour').value),
            log_level: document.getElementById('logLevel').value
        };

        try {
            // Use new API client
            const result = await window.apiClient.updateSettings(settings);
            
            if (result.success) {
                if (typeof app !== 'undefined') {
                    app.addLog('success', 'ƒê√£ l∆∞u c√†i ƒë·∫∑t th√†nh c√¥ng');
                }
                // Show success notification
                this.showNotification('success', 'C√†i ƒë·∫∑t ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!');
            } else {
                throw new Error(result.message || 'Kh√¥ng th·ªÉ l∆∞u c√†i ƒë·∫∑t');
            }
        } catch (error) {
            if (typeof app !== 'undefined') {
                app.addLog('error', `L·ªói l∆∞u c√†i ƒë·∫∑t: ${error.message}`);
            }
            this.showNotification('error', `L·ªói: ${error.message}`);
        }
    },

    async testTelegram() {
        const botToken = document.getElementById('telegramBotToken').value;
        const chatId = document.getElementById('telegramChatId').value;

        if (!botToken || !chatId) {
            if (typeof app !== 'undefined') {
                app.addLog('warning', 'Vui l√≤ng nh·∫≠p Bot Token v√† Chat ID');
            }
            this.showNotification('warning', 'Vui l√≤ng nh·∫≠p Bot Token v√† Chat ID');
            return;
        }

        try {
            // First update the settings with current values
            await window.apiClient.updateSetting('telegram_bot_token', botToken, 'telegram');
            await window.apiClient.updateSetting('telegram_chat_id', chatId, 'telegram');
            
            // Then test the connection
            const result = await window.apiClient.testTelegram();
            
            if (result.success) {
                if (typeof app !== 'undefined') {
                    app.addLog('success', 'ƒê√£ g·ª≠i tin nh·∫Øn test! Ki·ªÉm tra Telegram c·ªßa b·∫°n');
                }
                this.showNotification('success', 'ƒê√£ g·ª≠i tin nh·∫Øn test th√†nh c√¥ng! Ki·ªÉm tra Telegram c·ªßa b·∫°n.');
            } else {
                throw new Error(result.message || 'Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn test');
            }
        } catch (error) {
            if (typeof app !== 'undefined') {
                app.addLog('error', `L·ªói test Telegram: ${error.message}`);
            }
            this.showNotification('error', `L·ªói: ${error.message}`);
        }
    },

    async resetToDefault() {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën kh√¥i ph·ª•c c√†i ƒë·∫∑t m·∫∑c ƒë·ªãnh? T·∫•t c·∫£ c√†i ƒë·∫∑t hi·ªán t·∫°i s·∫Ω b·ªã x√≥a.')) {
            try {
                // Reset to default by reloading settings
                await this.loadSettings();
                this.showNotification('info', 'ƒê√£ kh√¥i ph·ª•c c√†i ƒë·∫∑t m·∫∑c ƒë·ªãnh');
            } catch (error) {
                this.showNotification('error', `L·ªói: ${error.message}`);
            }
        }
    },

    showNotification(type, message) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196f3'};
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }
};

// Database type change handler
document.getElementById('databaseType').addEventListener('change', (e) => {
    const postgresConfig = document.getElementById('postgresConfig');
    postgresConfig.style.display = e.target.value === 'postgresql' ? 'block' : 'none';
});

// Load settings on page load
settingsManager.loadSettings();
</script>
