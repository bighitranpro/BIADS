<!-- Task History Page Content -->
<style>
    .task-history-container {
        padding: 20px;
    }

    .task-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        border-radius: 12px;
        color: white;
        text-align: center;
    }

    .stat-card.pending {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card.processing {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-card.completed {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    .stat-card.failed {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .stat-number {
        font-size: 36px;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 14px;
        opacity: 0.9;
    }

    .filter-bar {
        background: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
    }

    .filter-bar select,
    .filter-bar input {
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.1);
        color: #e0e0e0;
        font-size: 14px;
    }

    .filter-bar button {
        padding: 8px 16px;
        border-radius: 8px;
        border: none;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .filter-bar button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .task-table {
        width: 100%;
        border-collapse: collapse;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        overflow: hidden;
    }

    .task-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .task-table th,
    .task-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .task-table tbody tr {
        transition: all 0.3s;
    }

    .task-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.08);
    }

    .task-status {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .task-status.pending {
        background: #f5576c;
        color: white;
    }

    .task-status.processing {
        background: #00f2fe;
        color: #000;
    }

    .task-status.completed {
        background: #43e97b;
        color: #000;
    }

    .task-status.failed {
        background: #fee140;
        color: #000;
    }

    .task-status.cancelled {
        background: #888;
        color: white;
    }
    
    /* Running task highlight animation */
    .task-running-row {
        animation: subtlePulse 2s ease-in-out infinite;
    }
    
    @keyframes subtlePulse {
        0%, 100% {
            background: rgba(255, 255, 255, 0.02);
        }
        50% {
            background: rgba(79, 172, 254, 0.1);
        }
    }
    
    .task-running-highlight {
        animation: highlightPulse 1.5s ease-in-out 3;
        border-left: 3px solid #00f2fe !important;
    }
    
    @keyframes highlightPulse {
        0%, 100% {
            background: rgba(255, 255, 255, 0.02);
        }
        50% {
            background: rgba(0, 242, 254, 0.2);
        }
    }
    
    /* Progress bar animation for running tasks */
    .task-status.processing {
        animation: statusPulse 1.5s ease-in-out infinite;
    }
    
    @keyframes statusPulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.7;
        }
    }

    .task-actions {
        display: flex;
        gap: 8px;
    }

    .task-actions button {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-view {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-delete {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
    }

    .btn-chrome {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
        transition: width 0.3s;
    }

    .chrome-sessions {
        margin-top: 30px;
        background: rgba(255, 255, 255, 0.05);
        padding: 20px;
        border-radius: 12px;
    }

    .chrome-session-card {
        background: rgba(255, 255, 255, 0.08);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .session-info {
        flex: 1;
    }

    .session-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-right: 8px;
    }

    .session-badge.headless {
        background: #667eea;
        color: white;
    }

    .session-badge.visible {
        background: #43e97b;
        color: #000;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #888;
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 20px;
    }
    
    /* Running Tasks Banner */
    .running-tasks-banner {
        background: linear-gradient(135deg, rgba(79, 172, 254, 0.1) 0%, rgba(0, 242, 254, 0.1) 100%);
        border: 2px solid rgba(79, 172, 254, 0.3);
        border-radius: 12px;
        padding: 15px 20px;
        margin-bottom: 20px;
        display: none;
    }
    
    .running-tasks-banner.has-tasks {
        display: block;
        animation: slideIn 0.5s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .running-tasks-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
        color: #00f2fe;
        font-weight: 600;
    }
    
    .running-tasks-header .icon {
        font-size: 24px;
        animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .running-tasks-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 10px;
    }
    
    .running-task-item {
        background: rgba(0, 0, 0, 0.2);
        padding: 12px;
        border-radius: 8px;
        border-left: 3px solid #00f2fe;
    }
    
    .running-task-name {
        font-weight: 600;
        color: #e0e0e0;
        margin-bottom: 5px;
    }
    
    .running-task-account {
        font-size: 12px;
        color: #999;
        margin-bottom: 8px;
    }
    
    .running-task-progress {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .running-task-progress .progress-bar {
        flex: 1;
        height: 6px;
    }
    
    .running-task-progress .progress-text {
        font-size: 12px;
        color: #00f2fe;
        font-weight: 600;
    }
    
    /* Running task animations */
    .task-running-row {
        position: relative;
        overflow: hidden;
    }
    
    .task-running-highlight {
        animation: taskPulse 2s ease-in-out infinite;
    }
    
    @keyframes taskPulse {
        0%, 100% {
            background-color: rgba(79, 172, 254, 0.05);
        }
        50% {
            background-color: rgba(79, 172, 254, 0.15);
        }
    }
    
    .progress-bar {
        position: relative;
        overflow: visible;
    }
    
    .task-running-row .progress-fill {
        animation: progressShine 1.5s ease-in-out infinite;
    }
    
    @keyframes progressShine {
        0% {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 50%, #4facfe 100%);
        }
        50% {
            background: linear-gradient(90deg, #00f2fe 0%, #4facfe 50%, #00f2fe 100%);
        }
        100% {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 50%, #4facfe 100%);
        }
    }
    
    /* Realtime indicator */
    .realtime-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #43e97b;
        border-radius: 50%;
        margin-left: 8px;
        animation: realtimePulse 1s ease-in-out infinite;
    }
    
    @keyframes realtimePulse {
        0%, 100% {
            opacity: 1;
            transform: scale(1);
        }
        50% {
            opacity: 0.5;
            transform: scale(1.2);
        }
    }
</style>

<div class="task-history-container">
    <!-- Stats -->
    <div class="task-stats">
        <div class="stat-card">
            <div class="stat-number" id="statTotal">0</div>
            <div class="stat-label">T·ªïng t√°c v·ª•</div>
        </div>
        <div class="stat-card pending">
            <div class="stat-number" id="statPending">0</div>
            <div class="stat-label">Ch·ªù x·ª≠ l√Ω</div>
        </div>
        <div class="stat-card processing">
            <div class="stat-number" id="statProcessing">0</div>
            <div class="stat-label">ƒêang ch·∫°y</div>
        </div>
        <div class="stat-card completed">
            <div class="stat-number" id="statCompleted">0</div>
            <div class="stat-label">Ho√†n th√†nh</div>
        </div>
        <div class="stat-card failed">
            <div class="stat-number" id="statFailed">0</div>
            <div class="stat-label">Th·∫•t b·∫°i</div>
        </div>
    </div>
    
    <!-- Running Tasks Banner -->
    <div class="running-tasks-banner" id="runningTasksBanner">
        <div class="running-tasks-header">
            <span class="icon">‚öôÔ∏è</span>
            <span>ƒêang ch·∫°y: <span id="runningTaskCount">0</span> t√°c v·ª•</span>
        </div>
        <div class="running-tasks-list" id="runningTasksList">
            <!-- Running tasks will be rendered here -->
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <select id="filterStatus">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="pending">Ch·ªù x·ª≠ l√Ω</option>
            <option value="processing">ƒêang ch·∫°y</option>
            <option value="completed">Ho√†n th√†nh</option>
            <option value="failed">Th·∫•t b·∫°i</option>
            <option value="cancelled">ƒê√£ h·ªßy</option>
        </select>

        <select id="filterTaskType">
            <option value="">T·∫•t c·∫£ lo·∫°i t√°c v·ª•</option>
            <option value="join_groups">Tham gia nh√≥m</option>
            <option value="add_friends">K·∫øt b·∫°n</option>
            <option value="post_content">ƒêƒÉng b√†i</option>
            <option value="comment">B√¨nh lu·∫≠n</option>
            <option value="react">Th·∫£ c·∫£m x√∫c</option>
        </select>

        <button onclick="taskHistory.loadTasks()">üîç L·ªçc</button>
        <button onclick="taskHistory.refreshTasks()">üîÑ L√†m m·ªõi</button>
        <button onclick="taskHistory.clearHistory()">üóëÔ∏è X√≥a l·ªãch s·ª≠</button>
    </div>

    <!-- Task Table -->
    <div style="overflow-x: auto;">
        <table class="task-table">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Task ID</th>
                    <th>T√†i kho·∫£n</th>
                    <th>Lo·∫°i t√°c v·ª•</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Ti·∫øn ƒë·ªô</th>
                    <th>Th·ªùi gian</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody id="taskTableBody">
                <tr>
                    <td colspan="8">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <h3>ƒêang t·∫£i l·ªãch s·ª≠ t√°c v·ª•...</h3>
                            <p>Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Chrome Sessions -->
    <div class="chrome-sessions">
        <h3 style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
            <span>üåê Chrome Sessions ƒëang ho·∫°t ƒë·ªông</span>
            <button class="filter-bar button" onclick="taskHistory.closeAllChrome()" style="padding: 6px 12px; font-size: 13px;">
                ƒê√≥ng t·∫•t c·∫£
            </button>
        </h3>
        <div id="chromeSessionsContainer">
            <div class="empty-state" style="padding: 30px;">
                <div class="empty-state-icon" style="font-size: 48px;">üîç</div>
                <p>Ch∆∞a c√≥ Chrome session n√†o ƒëang ho·∫°t ƒë·ªông</p>
            </div>
        </div>
    </div>
</div>

<script>
    const taskHistory = {
        tasks: [],
        chromeSessions: [],
        runningTasks: [],
        lastCompletedTasks: [],

        async init() {
            await this.loadStats();
            await this.loadTasks();
            await this.loadChromeSessions();

            // Auto refresh every 5 seconds
            setInterval(() => {
                this.loadStats();
                this.loadChromeSessions();
            }, 5000);
            
            // Poll running tasks every 3 seconds for realtime updates
            setInterval(() => {
                this.pollRunningTasks();
            }, 3000);
            
            // Initial poll
            this.pollRunningTasks();
        },
        
        async pollRunningTasks() {
            try {
                const response = await fetch('http://localhost:8000/api/task/running');
                const data = await response.json();
                
                if (data.success) {
                    const newRunningTasks = data.running_tasks;
                    
                    // Check for newly completed tasks
                    this.runningTasks.forEach(oldTask => {
                        const stillRunning = newRunningTasks.find(t => t.task_id === oldTask.task_id);
                        if (!stillRunning && !this.lastCompletedTasks.includes(oldTask.task_id)) {
                            // Task completed!
                            this.lastCompletedTasks.push(oldTask.task_id);
                            this.notifyTaskComplete(oldTask);
                        }
                    });
                    
                    // Update running tasks
                    this.runningTasks = newRunningTasks;
                    
                    // Render running tasks banner
                    this.renderRunningTasksBanner();
                    
                    // Update progress for running tasks in table
                    this.updateRunningTasksInTable();
                }
            } catch (error) {
                console.error('Error polling running tasks:', error);
            }
        },
        
        renderRunningTasksBanner() {
            const banner = document.getElementById('runningTasksBanner');
            const countEl = document.getElementById('runningTaskCount');
            const listEl = document.getElementById('runningTasksList');
            
            if (this.runningTasks.length === 0) {
                banner.classList.remove('has-tasks');
                return;
            }
            
            banner.classList.add('has-tasks');
            countEl.textContent = this.runningTasks.length;
            
            listEl.innerHTML = this.runningTasks.map(task => `
                <div class="running-task-item">
                    <div class="running-task-name">${task.task_name || task.task_type}</div>
                    <div class="running-task-account">
                        ${task.account ? `üë§ ${task.account.name || task.account.uid}` : 'N/A'}
                    </div>
                    <div class="running-task-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${task.progress}%"></div>
                        </div>
                        <span class="progress-text">${task.progress}%</span>
                    </div>
                </div>
            `).join('');
        },
        
        updateRunningTasksInTable() {
            // Update progress bars for running tasks
            this.runningTasks.forEach(runningTask => {
                const row = document.querySelector(`tr[data-task-id="${runningTask.task_id}"]`);
                if (row) {
                    // Update progress bar
                    const progressFill = row.querySelector('.progress-fill');
                    const progressText = row.querySelector('.progress-text');
                    if (progressFill) {
                        progressFill.style.width = `${runningTask.progress}%`;
                    }
                    if (progressText) {
                        progressText.textContent = `${runningTask.progress}%`;
                    }
                    
                    // Add pulsing animation
                    row.classList.add('task-running-highlight');
                }
            });
        },
        
        notifyTaskComplete(task) {
            BiAds.showToast('success', 'Task ho√†n th√†nh', 
                `${task.task_name} ƒë√£ ho√†n th√†nh cho t√†i kho·∫£n ${task.account?.name || task.account?.uid}`);
            
            // Reload tasks to show updated status
            setTimeout(() => {
                this.loadTasks();
            }, 1000);
        },

        async loadStats() {
            try {
                const response = await fetch('http://localhost:8000/api/tasks/stats');
                const data = await response.json();

                if (data.success) {
                    const stats = data.stats;
                    document.getElementById('statTotal').textContent = stats.total;
                    document.getElementById('statPending').textContent = stats.pending;
                    document.getElementById('statProcessing').textContent = stats.processing;
                    document.getElementById('statCompleted').textContent = stats.completed;
                    document.getElementById('statFailed').textContent = stats.failed;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        },

        async loadTasks() {
            try {
                const status = document.getElementById('filterStatus').value;
                const taskType = document.getElementById('filterTaskType').value;

                let url = 'http://localhost:8000/api/tasks/history?limit=50';
                if (status) url += `&status=${status}`;
                if (taskType) url += `&task_type=${taskType}`;

                const response = await fetch(url);
                const tasks = await response.json();

                this.tasks = tasks;
                this.renderTasks();
            } catch (error) {
                console.error('Error loading tasks:', error);
                BiAds.showToast('error', 'L·ªói t·∫£i l·ªãch s·ª≠', error.message);
            }
        },

        renderTasks() {
            const tbody = document.getElementById('taskTableBody');

            if (this.tasks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìã</div>
                                <h3>Ch∆∞a c√≥ t√°c v·ª• n√†o</h3>
                                <p>L·ªãch s·ª≠ t√°c v·ª• s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = this.tasks.map((task, index) => `
                <tr data-task-id="${task.task_id}" class="${task.status === 'processing' || task.status === 'pending' ? 'task-running-row' : ''}">
                    <td>${index + 1}</td>
                    <td><code>${task.task_id.substring(0, 8)}...</code></td>
                    <td>
                        <div>${task.account_name || 'N/A'}</div>
                        <small style="color: #888;">${task.account_uid}</small>
                    </td>
                    <td>${this.getTaskTypeName(task.task_type)}</td>
                    <td><span class="task-status ${task.status}">${this.getStatusName(task.status)}</span></td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${task.progress}%"></div>
                        </div>
                        <small class="progress-text">${task.progress}%</small>
                    </td>
                    <td>
                        <small>${new Date(task.created_at).toLocaleString('vi-VN')}</small>
                    </td>
                    <td>
                        <div class="task-actions">
                            <button class="btn-view" onclick="taskHistory.viewTask('${task.task_id}')">
                                üëÅÔ∏è Xem
                            </button>
                            <button class="btn-chrome" onclick="taskHistory.openChrome(${task.account_id})">
                                üåê Chrome
                            </button>
                            <button class="btn-delete" onclick="taskHistory.deleteTask('${task.task_id}')">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        },

        async loadChromeSessions() {
            try {
                const response = await fetch('http://localhost:8000/api/tasks/chrome/sessions');
                const sessions = await response.json();

                this.chromeSessions = sessions;
                this.renderChromeSessions();
            } catch (error) {
                console.error('Error loading Chrome sessions:', error);
            }
        },

        renderChromeSessions() {
            const container = document.getElementById('chromeSessionsContainer');

            if (this.chromeSessions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 30px;">
                        <div class="empty-state-icon" style="font-size: 48px;">üîç</div>
                        <p>Ch∆∞a c√≥ Chrome session n√†o ƒëang ho·∫°t ƒë·ªông</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = this.chromeSessions.map(session => `
                <div class="chrome-session-card">
                    <div class="session-info">
                        <div>
                            <span class="session-badge ${session.is_headless ? 'headless' : 'visible'}">
                                ${session.is_headless ? 'üëÅÔ∏è‚Äçüó®Ô∏è Headless' : 'üëÅÔ∏è Visible'}
                            </span>
                            <strong>${session.account_uid}</strong>
                            ${session.has_proxy ? `üåê ${session.proxy_ip}` : ''}
                        </div>
                        <small style="color: #888;">
                            Status: ${session.status} | 
                            Created: ${new Date(session.created_at).toLocaleTimeString('vi-VN')}
                        </small>
                    </div>
                    <div class="task-actions">
                        <button class="btn-view" onclick="taskHistory.toggleChrome(${session.account_id})">
                            ${session.is_headless ? 'üëÅÔ∏è M·ªü' : 'üëÅÔ∏è‚Äçüó®Ô∏è ·∫®n'}
                        </button>
                        <button class="btn-delete" onclick="taskHistory.closeChrome(${session.account_id})">
                            ‚ùå ƒê√≥ng
                        </button>
                    </div>
                </div>
            `).join('');
        },

        async openChrome(accountId) {
            try {
                BiAds.showLoading('ƒêang kh·ªüi ƒë·ªông Chrome...', 'Vui l√≤ng ƒë·ª£i');

                const response = await fetch('http://localhost:8000/api/tasks/chrome/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ account_id: accountId, headless: true })
                });

                const data = await response.json();

                if (response.ok) {
                    BiAds.showToast('success', 'Chrome ƒë√£ kh·ªüi ƒë·ªông', `Account: ${data.account_uid}`);
                    await this.loadChromeSessions();
                } else {
                    throw new Error(data.detail || 'Failed to open Chrome');
                }
            } catch (error) {
                BiAds.showToast('error', 'L·ªói m·ªü Chrome', error.message);
            }
        },

        async toggleChrome(accountId) {
            try {
                const response = await fetch(`http://localhost:8000/api/tasks/chrome/toggle/${accountId}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    BiAds.showToast('success', 'ƒê√£ chuy·ªÉn ƒë·ªïi', data.message);
                    await this.loadChromeSessions();
                }
            } catch (error) {
                BiAds.showToast('error', 'L·ªói toggle Chrome', error.message);
            }
        },

        async closeChrome(accountId) {
            try {
                const response = await fetch(`http://localhost:8000/api/tasks/chrome/session/${accountId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    BiAds.showToast('success', 'ƒê√£ ƒë√≥ng Chrome', data.message);
                    await this.loadChromeSessions();
                }
            } catch (error) {
                BiAds.showToast('error', 'L·ªói ƒë√≥ng Chrome', error.message);
            }
        },

        async closeAllChrome() {
            if (!confirm('ƒê√≥ng t·∫•t c·∫£ Chrome sessions?')) return;

            try {
                const response = await fetch('http://localhost:8000/api/tasks/chrome/close-all', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    BiAds.showToast('success', 'ƒê√£ ƒë√≥ng t·∫•t c·∫£', data.message);
                    await this.loadChromeSessions();
                }
            } catch (error) {
                BiAds.showToast('error', 'L·ªói', error.message);
            }
        },

        async viewTask(taskId) {
            try {
                const response = await fetch(`http://localhost:8000/api/tasks/history/${taskId}`);
                const data = await response.json();

                if (data.success) {
                    const task = data.task;
                    BiAds.showToast('info', 'Chi ti·∫øt t√°c v·ª•', 
                        `Type: ${task.task_type}\nStatus: ${task.status}\nProgress: ${task.progress}%`);
                }
            } catch (error) {
                BiAds.showToast('error', 'L·ªói xem chi ti·∫øt', error.message);
            }
        },

        async deleteTask(taskId) {
            if (!confirm('X√≥a t√°c v·ª• n√†y kh·ªèi l·ªãch s·ª≠?')) return;

            try {
                const response = await fetch(`http://localhost:8000/api/tasks/history/${taskId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    BiAds.showToast('success', 'ƒê√£ x√≥a', 'T√°c v·ª• ƒë√£ ƒë∆∞·ª£c x√≥a kh·ªèi l·ªãch s·ª≠');
                    await this.loadTasks();
                    await this.loadStats();
                }
            } catch (error) {
                BiAds.showToast('error', 'L·ªói x√≥a t√°c v·ª•', error.message);
            }
        },

        async clearHistory() {
            if (!confirm('X√≥a to√†n b·ªô l·ªãch s·ª≠ t√°c v·ª•? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) return;

            try {
                const response = await fetch('http://localhost:8000/api/tasks/history/clear', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    BiAds.showToast('success', 'ƒê√£ x√≥a', `${data.count} t√°c v·ª• ƒë√£ ƒë∆∞·ª£c x√≥a`);
                    await this.loadTasks();
                    await this.loadStats();
                }
            } catch (error) {
                BiAds.showToast('error', 'L·ªói x√≥a l·ªãch s·ª≠', error.message);
            }
        },

        refreshTasks() {
            this.loadStats();
            this.loadTasks();
            this.loadChromeSessions();
            BiAds.showToast('info', 'ƒê√£ l√†m m·ªõi', 'L·ªãch s·ª≠ v√† sessions ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t');
        },

        getTaskTypeName(type) {
            const names = {
                'join_groups': 'Tham gia nh√≥m',
                'add_friends': 'K·∫øt b·∫°n',
                'post_content': 'ƒêƒÉng b√†i',
                'comment': 'B√¨nh lu·∫≠n',
                'react': 'Th·∫£ c·∫£m x√∫c'
            };
            return names[type] || type;
        },

        getStatusName(status) {
            const names = {
                'pending': 'Ch·ªù x·ª≠ l√Ω',
                'processing': 'ƒêang ch·∫°y',
                'completed': 'Ho√†n th√†nh',
                'failed': 'Th·∫•t b·∫°i',
                'cancelled': 'ƒê√£ h·ªßy'
            };
            return names[status] || status;
        }
    };

    // Auto-init when page loads
    setTimeout(() => taskHistory.init(), 100);
</script>
