<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Qu·∫£n L√Ω T√†i Kho·∫£n - Bi Ads</title>
    <link rel="stylesheet" href="renderer/styles.css">
</head>
<body style="padding: 20px;">
    <div class="card">
        <div class="card-header">
            üß™ Test Qu·∫£n L√Ω T√†i Kho·∫£n
            <button class="btn-primary" onclick="testAll()" style="float: right;">
                ‚ñ∂Ô∏è Ch·∫°y t·∫•t c·∫£ test
            </button>
        </div>
        <div class="card-body">
            <div id="testResults"></div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">üìã Nh·∫≠t K√Ω Ho·∫°t ƒê·ªông</div>
        <div class="card-body">
            <div class="console" id="activityLog" style="height: 300px;">
                <!-- Log will appear here -->
            </div>
            <button class="btn-secondary" onclick="clearLog()" style="margin-top: 10px;">
                üóëÔ∏è X√≥a log
            </button>
        </div>
    </div>

    <script src="renderer/api-client.js"></script>
    <script>
        // Logging function
        function log(level, message) {
            const logDiv = document.getElementById('activityLog');
            if (!logDiv) return;
            
            const line = document.createElement('div');
            line.className = 'console-line';
            
            const levelText = {
                'info': '[TH√îNG TIN]',
                'success': '[TH√ÄNH C√îNG]',
                'error': '[L·ªñI]',
                'warning': '[C·∫¢NH B√ÅO]'
            };
            
            line.innerHTML = `
                <span class="console-timestamp">${new Date().toLocaleTimeString('vi-VN')}</span>
                <span class="console-level ${level}">${levelText[level]}</span>
                <span class="console-message">${message}</span>
            `;
            
            logDiv.appendChild(line);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            const logDiv = document.getElementById('activityLog');
            if (logDiv) {
                logDiv.innerHTML = '';
                log('info', 'ƒê√£ x√≥a log');
            }
        }

        function addResult(testName, success, details) {
            const results = document.getElementById('testResults');
            const result = document.createElement('div');
            result.className = 'info-box';
            result.style.borderLeft = success ? '4px solid #38ef7d' : '4px solid #f45c43';
            result.innerHTML = `
                <h4>${success ? '‚úÖ' : '‚ùå'} ${testName}</h4>
                <p>${details}</p>
            `;
            results.appendChild(result);
        }

        async function testBackendConnection() {
            log('info', 'üîç Test 1: Ki·ªÉm tra k·∫øt n·ªëi backend...');
            try {
                const health = await apiClient.healthCheck();
                log('success', `‚úÖ Backend online: ${health.status} - ${health.version}`);
                addResult('Backend Connection', true, `Status: ${health.status}, Version: ${health.version}, Database: ${health.database}`);
                return true;
            } catch (error) {
                log('error', `‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi backend: ${error.message}`);
                addResult('Backend Connection', false, error.message);
                return false;
            }
        }

        async function testLoadAccounts() {
            log('info', 'üîç Test 2: T·∫£i danh s√°ch t√†i kho·∫£n...');
            try {
                const accounts = await apiClient.getAccounts();
                log('success', `‚úÖ ƒê√£ t·∫£i ${accounts.length} t√†i kho·∫£n`);
                addResult('Load Accounts', true, `T·∫£i ƒë∆∞·ª£c ${accounts.length} t√†i kho·∫£n t·ª´ database`);
                return accounts;
            } catch (error) {
                log('error', `‚ùå L·ªói t·∫£i t√†i kho·∫£n: ${error.message}`);
                addResult('Load Accounts', false, error.message);
                return [];
            }
        }

        async function testLoadProxies() {
            log('info', 'üîç Test 3: T·∫£i danh s√°ch proxy...');
            try {
                const proxies = await apiClient.getProxies();
                log('success', `‚úÖ ƒê√£ t·∫£i ${proxies.length} proxy`);
                addResult('Load Proxies', true, `T·∫£i ƒë∆∞·ª£c ${proxies.length} proxy t·ª´ database`);
                return proxies;
            } catch (error) {
                log('error', `‚ùå L·ªói t·∫£i proxy: ${error.message}`);
                addResult('Load Proxies', false, error.message);
                return [];
            }
        }

        async function testCheckAccountStatus(accounts) {
            if (accounts.length === 0) {
                log('warning', '‚ö†Ô∏è Test 4: B·ªè qua - Kh√¥ng c√≥ t√†i kho·∫£n ƒë·ªÉ test');
                return;
            }

            log('info', `üîç Test 4: Ki·ªÉm tra tr·∫°ng th√°i t√†i kho·∫£n ID ${accounts[0].id}...`);
            try {
                const result = await apiClient.checkAccountStatus(accounts[0].id);
                const status = result.is_live ? '‚úÖ LIVE' : '‚ùå DIE';
                log('success', `${status} - ${result.reason}`);
                addResult('Check Account Status', true, `T√†i kho·∫£n ${accounts[0].uid}: ${status} - ${result.reason}`);
            } catch (error) {
                log('error', `‚ùå L·ªói ki·ªÉm tra: ${error.message}`);
                addResult('Check Account Status', false, error.message);
            }
        }

        async function testAssignProxy(accounts, proxies) {
            if (accounts.length === 0 || proxies.length === 0) {
                log('warning', '‚ö†Ô∏è Test 5: B·ªè qua - Kh√¥ng c√≥ t√†i kho·∫£n ho·∫∑c proxy ƒë·ªÉ test');
                return;
            }

            log('info', `üîç Test 5: G√°n proxy ${proxies[0].id} cho t√†i kho·∫£n ${accounts[0].id}...`);
            try {
                const result = await apiClient.assignProxyToAccount(accounts[0].id, proxies[0].id);
                log('success', `‚úÖ ${result.message}`);
                addResult('Assign Proxy', true, `ƒê√£ g√°n proxy ${proxies[0].ip}:${proxies[0].port} cho t√†i kho·∫£n ${accounts[0].uid}`);
                
                // Verify
                log('info', 'üîç Ki·ªÉm tra l·∫°i t√†i kho·∫£n sau khi g√°n...');
                const account = await apiClient.getAccount(accounts[0].id);
                if (account.proxy_id === proxies[0].id) {
                    log('success', `‚úÖ X√°c nh·∫≠n: Proxy ƒë√£ ƒë∆∞·ª£c g√°n th√†nh c√¥ng`);
                } else {
                    log('warning', `‚ö†Ô∏è Proxy ID kh√¥ng kh·ªõp: ${account.proxy_id} vs ${proxies[0].id}`);
                }
            } catch (error) {
                log('error', `‚ùå L·ªói g√°n proxy: ${error.message}`);
                addResult('Assign Proxy', false, error.message);
            }
        }

        async function testUnassignProxy(accounts) {
            if (accounts.length === 0) {
                log('warning', '‚ö†Ô∏è Test 6: B·ªè qua - Kh√¥ng c√≥ t√†i kho·∫£n ƒë·ªÉ test');
                return;
            }

            log('info', `üîç Test 6: G·ª° proxy kh·ªèi t√†i kho·∫£n ${accounts[0].id}...`);
            try {
                const result = await apiClient.assignProxyToAccount(accounts[0].id, null);
                log('success', `‚úÖ ${result.message}`);
                addResult('Unassign Proxy', true, `ƒê√£ g·ª° proxy kh·ªèi t√†i kho·∫£n ${accounts[0].uid}`);
            } catch (error) {
                log('error', `‚ùå L·ªói g·ª° proxy: ${error.message}`);
                addResult('Unassign Proxy', false, error.message);
            }
        }

        async function testAll() {
            document.getElementById('testResults').innerHTML = '';
            clearLog();
            
            log('info', 'üöÄ B·∫Øt ƒë·∫ßu ch·∫°y test suite...');
            log('info', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            // Test 1: Backend connection
            const backendOk = await testBackendConnection();
            if (!backendOk) {
                log('error', '‚ùå Backend kh√¥ng ho·∫°t ƒë·ªông. D·ª´ng test.');
                return;
            }
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Test 2: Load accounts
            const accounts = await testLoadAccounts();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Test 3: Load proxies
            const proxies = await testLoadProxies();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Test 4: Check status
            await testCheckAccountStatus(accounts);
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Test 5: Assign proxy
            await testAssignProxy(accounts, proxies);
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Test 6: Unassign proxy
            await testUnassignProxy(accounts);
            
            log('info', '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            log('success', 'üéâ Ho√†n th√†nh t·∫•t c·∫£ test!');
        }

        // Auto-run on load
        window.addEventListener('DOMContentLoaded', () => {
            log('info', 'Test suite ƒë√£ s·∫µn s√†ng. Nh·∫•n "Ch·∫°y t·∫•t c·∫£ test" ƒë·ªÉ b·∫Øt ƒë·∫ßu.');
        });
    </script>
</body>
</html>
